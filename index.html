<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: url('images/background.jpg') no-repeat center center fixed;
            background-size: cover;
        }
        .container {
            width: 100%;
            max-width: 1350px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .header {
            display: flex;
            align-items: center;
            background-color: #fbfbfb;
            color: black;
            padding: 35px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .header img {
            height: 40px;
            margin-right: 250px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .stats div {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .order-details, .milestones, .tracking {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .chart {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .chart div {
            flex: 1;
            margin: 0 10px;
        }
        .tracking {
            display: none; /* Initially hidden */
        }
        .tracking .tracking-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .tracking .tracking-row div {
            flex: 1;
            margin: 5px 10px;
        }
        .stats h3 {
            font-size: 18px;
            margin: 0 0 10px;
        }
        .stats p {
            font-size: 16px;
            margin: 0;
            color: #333;
        }
        .order-details h3, .milestones h3, .tracking h3 {
            font-size: 20px;
            margin-bottom: 20px;
        }
        .tracking table {
            margin-top: 10px;
        }
        .highlight {
            background-color: #f0f0f0;
        }
        .visualization {
            display: flex;
            justify-content: space-between;
            margin-top: 100px;
        }
        .step {
            position: relative;
            text-align: center;
            flex: 1;
        }
        .step .step-dot {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        .step .step-line {
            position: absolute;
            top: 12px;
            left: 50%;
            width: 100%;
            height: 2px;
            background-color: #ccc;
            z-index: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="images/logo.png" alt="GBSL">
            <h1>Customer Dashboard</h1>
        </div>

        <div class="stats">
            <div>
                <h3>New Orders</h3>
                <p id="newOrders">0</p>
            </div>
            <div>
                <h3>Total Orders</h3>
                <p id="totalOrders">0</p>
            </div>
            <div>
                <h3>Shipped Orders</h3>
                <p id="shippedOrders">0</p>
            </div>
            <div>
                <h3>Pending to Ship</h3>
                <p id="pendingToShip">0</p>
            </div>
            <div>
                <h3>Upcoming Shipment</h3>
                <p id="upcomingShipment">0</p>
            </div>
        </div>

        <div class="order-details">
            <h3>Order Details</h3>
            <table id="orderTable">
                <tr>
                    <th>Date</th>
                    <th>PO Number</th>
                    <th>Customer Name</th>
                    <th>Port Of Origin</th>
                    <th>Port Of Destination</th>
                    <th>ETD</th>
                    <th>Country</th>
                </tr>
                <!-- Rows will be populated by JavaScript -->
            </table>
        </div>

        <div class="milestones">
            <h3>PO Current Status:</h3>
            <div class="chart">
                <div>
                    <table id="milestonesTable">
                        <tr>
                            <th>Steps</th>
                            <th>Number of PO's</th>
                        </tr>
                        <!-- Rows will be populated by JavaScript -->
                    </table>
                </div>
                <div>
                    <canvas id="poChart"></canvas>
                </div>
            </div>
        </div>

        <div class="tracking" id="trackingSection">
            <h3>Tracking</h3>
            <div class="tracking-row">
                <div><b>PO Number</b> – <span id="trackingPONumber"></span></div>
                <div><b>Customer Name</b> – <span id="trackingCustomerName"></span></div>
                <div><b>ETD</b> – <span id="trackingETD"></span></div>
            </div>
            <div class="tracking-row">
                <div><b>Port of Origin</b> – <span id="trackingPortOfOrigin"></span></div>
                <div><b>Port Of Destination</b> – <span id="trackingPortOfDestination"></span></div>
                <div><b>Current Stage</b> – <span id="trackingShippedDate"></span></div>
            </div>
            <table id="trackingTable">
                <tr>
                    <th>Step</th>
                    <th>Planned Date</th>
                    <th>Actual Date</th>
                    <th>Status</th>
                    <th>Remark</th>
                </tr>
                <tr>
                    <td>Pre-Production Meeting</td>
                    <td id="ppPlannedDate"></td>
                    <td id="ppActualDate"></td>
                    <td id="ppStatus"></td>
                    <td id="ppRemark"></td>
                </tr>
                <tr>
                    <td>Label Artwork Approval</td>
                    <td id="laPlannedDate"></td>
                    <td id="laActualDate"></td>
                    <td id="laStatus"></td>
                    <td id="laRemark"></td>
                </tr>
                <tr>
                    <td>Cargo Booking submission and SO Received</td>
                    <td id="cbPlannedDate"></td>
                    <td id="cbActualDate"></td>
                    <td id="cbStatus"></td>
                    <td id="cbRemark"></td>
                </tr>
                <tr>
                    <td>Midline Inspection</td>
                    <td id="miPlannedDate"></td>
                    <td id="miActualDate"></td>
                    <td id="miStatus"></td>
                    <td id="miRemark"></td>
                </tr>
                <tr>
                    <td>Final Inspection Report Submission and Approval</td>
                    <td id="fiPlannedDate"></td>
                    <td id="fiActualDate"></td>
                    <td id="fiStatus"></td>
                    <td id="fiRemark"></td>
                </tr>
                <tr>
                    <td>BL Received</td>
                    <td id="blPlannedDate"></td>
                    <td id="blActualDate"></td>
                    <td id="blStatus"></td>
                    <td id="blRemark"></td>
                </tr>
                <tr>
                    <td>Payment Realization and Confirmation</td>
                    <td id="prPlannedDate"></td>
                    <td id="prActualDate"></td>
                    <td id="prStatus"></td>
                    <td id="prRemark"></td>
                </tr>
            </table>
        </div>

        <div class="visualization" id="visualization">
            <!-- Steps will be populated by JavaScript -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_KEY = 'AIzaSyDIQwldr8SG1D71XI82vGycV0ueZ-cesV0';
        const SPREADSHEET_ID = '1oJ-b5TVSqJraKdavPEvOKAb84aWhloxqxaeFSqmoHco';
        const ORDER_RANGE = 'Orders!A1:G'; // Adjust the range as per your sheet
        const MILESTONES_RANGE = 'Milestones!N1:O'; // Adjust the range as per your sheet
        const TRACKING_RANGE = 'Tracking!A1:AC'; // Adjust the range as per your sheet
        const GRAPH_RANGE = 'Graph!A1:H'; // Adjust the range as per your sheet
        const OTHER_DETAILS_RANGES = [
            { id: 'newOrders', range: 'Other Details!A1:A2' },
            { id: 'totalOrders', range: 'Other Details!B1:B2' },
            { id: 'shippedOrders', range: 'Other Details!C1:C2' },
            { id: 'pendingToShip', range: 'Other Details!D1:D2' },
            { id: 'upcomingShipment', range: 'Other Details!E1:E2' }
        ];

        // Function to fetch data from Google Sheets
        async function fetchData(range) {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}`);
            const data = await response.json();
            if (data.error) {
                console.error('Error fetching data:', data.error);
                return [];
            }
            return data.values;
        }

        // Function to populate the order table
        function populateOrderTable(orders) {
            const table = document.getElementById('orderTable');
            table.innerHTML = `
                <tr>
                    <th>Date</th>
                    <th>PO Number</th>
                    <th>Customer Name</th>
                    <th>Port Of Origin</th>
                    <th>Port Of Destination</th>
                    <th>ETD</th>
                    <th>Stage</th>
                </tr>`;
            orders.slice(1).forEach(order => {
                const row = table.insertRow();
                order.forEach((cellData, index) => {
                    const cell = row.insertCell();
                    cell.textContent = cellData;
                    if (index === 1) {
                        cell.classList.add('po-number');
                        cell.dataset.po = cellData;
                        cell.addEventListener('click', () => showTracking(order, row));
                    }
                });
            });
        }

        // Function to populate the milestones table
        function populateMilestonesTable(milestones) {
            const table = document.getElementById('milestonesTable');
            table.innerHTML = `
                <tr>
                    <th>Steps</th>
                    <th>Number of PO's</th>
                </tr>`;
            milestones.slice(1).forEach(milestone => {
                const row = table.insertRow();
                milestone.forEach(cellData => {
                    const cell = row.insertCell();
                    cell.textContent = cellData;
                });
            });
        }

        // Function to update the chart
        function updateChart(milestones) {
            const labels = milestones.slice(1).map(milestone => milestone[0]);
            const data = milestones.slice(1).map(milestone => parseInt(milestone[1], 10) || 0);

            const ctx = document.getElementById('poChart').getContext('2d');
            if (window.poChart && typeof window.poChart.destroy === 'function') {
                window.poChart.destroy();
            }
            window.poChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of PO\'s',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Function to show tracking details
        async function showTracking(order, row) {
            const trackingSection = document.getElementById('trackingSection');
            if (!trackingSection) {
                console.error('Tracking section not found');
                return;
            }

            const trackingElements = [
                { id: 'trackingPONumber', value: order[1] },
                { id: 'trackingPortOfOrigin', value: order[3] },
                { id: 'trackingETD', value: order[5] },
                { id: 'trackingCustomerName', value: order[2] },
                { id: 'trackingPortOfDestination', value: order[4] },
                { id: 'trackingShippedDate', value: order[6] } // Example date, you can update this as needed
            ];

            trackingElements.forEach(el => {
                const element = document.getElementById(el.id);
                if (element) {
                    element.textContent = el.value;
                } else {
                    console.error(`Element with id ${el.id} not found`);
                }
            });

            const trackingData = await fetchData(TRACKING_RANGE);
            const poTrackingData = trackingData.find(data => data[0] === order[1]);

            if (poTrackingData) {
                const trackingDetails = [
                    { id: 'ppPlannedDate', index: 1 },
                    { id: 'ppActualDate', index: 2 },
                    { id: 'ppStatus', index: 3 },
                    { id: 'ppRemark', index: 4 },
                    { id: 'laPlannedDate', index: 5 },
                    { id: 'laActualDate', index: 6 },
                    { id: 'laStatus', index: 7 },
                    { id: 'laRemark', index: 8 },
                    { id: 'cbPlannedDate', index: 9 },
                    { id: 'cbActualDate', index: 10 },
                    { id: 'cbStatus', index: 11 },
                    { id: 'cbRemark', index: 12 },
                    { id: 'miPlannedDate', index: 13 },
                    { id: 'miActualDate', index: 14 },
                    { id: 'miStatus', index: 15 },
                    { id: 'miRemark', index: 16 },
                    { id: 'fiPlannedDate', index: 17 },
                    { id: 'fiActualDate', index: 18 },
                    { id: 'fiStatus', index: 19 },
                    { id: 'fiRemark', index: 20 },
                    { id: 'blPlannedDate', index: 21 },
                    { id: 'blActualDate', index: 22 },
                    { id: 'blStatus', index: 23 },
                    { id: 'blRemark', index: 24 },
                    { id: 'prPlannedDate', index: 25 },
                    { id: 'prActualDate', index: 26 },
                    { id: 'prStatus', index: 27 },
                    { id: 'prRemark', index: 28 }
                ];

                trackingDetails.forEach(detail => {
                    const element = document.getElementById(detail.id);
                    if (element) {
                        element.textContent = poTrackingData[detail.index] || 'N/A';
                    } else {
                        console.error(`Element with id ${detail.id} not found`);
                    }
                });

                // Update visualization
                updateVisualization(poTrackingData.slice(1));
            } else {
                console.error('No tracking data found for PO:', order[1]);
            }

            trackingSection.style.display = 'block';

            // Remove highlight from previous row
            const previouslyHighlighted = document.querySelector('.highlight');
            if (previouslyHighlighted) {
                previouslyHighlighted.classList.remove('highlight');
            }
            // Highlight the selected row
            row.classList.add('highlight');
        }

        // Function to update the visualization
        function updateVisualization(trackingData) {
            const steps = [
                'Pre-Production Meeting',
                'Label Artwork Approval',
                'Cargo Booking submission and SO Received',
                'Midline Inspection',
                'Final Inspection Report Submission and Approval',
                'BL Received',
                'Payment Realization and Confirmation'
            ];

            const visualization = document.getElementById('visualization');
            visualization.innerHTML = '';

            steps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.classList.add('step');

                const stepDot = document.createElement('div');
                stepDot.classList.add('step-dot');
                stepDot.style.backgroundColor = trackingData[index * 4 + 2] === 'Done' ? '#1fd655' : '#ccc';

                // Add ship emoji if the step is done
                if (trackingData[index * 4 + 2] === 'Done') {
                    const shipEmoji = document.createElement('div');
                    shipEmoji.textContent = '✔️';
                    shipEmoji.style.position = 'absolute';
                    shipEmoji.style.top = '-25px';
                    shipEmoji.style.left = 'calc(50% - 10px)';
                    stepDiv.appendChild(shipEmoji);
                }

                stepDiv.appendChild(stepDot);

                const stepText = document.createElement('div');
                stepText.textContent = step;
                stepDiv.appendChild(stepText);

                visualization.appendChild(stepDiv);

                if (index < steps.length - 1) {
                    const stepLine = document.createElement('div');
                    stepLine.classList.add('step-line');
                    stepLine.style.backgroundColor = trackingData[index * 4 + 2] === 'Done' ? '#1fd655' : '#ccc';
                    stepDiv.appendChild(stepLine);
                }
            });
        }

        // Function to update the dashboard data
        function updateData() {
            fetchData(ORDER_RANGE).then(populateOrderTable).catch(error => console.error('Error fetching order data:', error));
            fetchData(MILESTONES_RANGE).then(milestones => {
                populateMilestonesTable(milestones);
                updateChart(milestones);
            }).catch(error => console.error('Error fetching milestones data:', error));

            OTHER_DETAILS_RANGES.forEach(detail => {
                fetchData(detail.range).then(data => {
                    if (data.length > 1) {
                        document.getElementById(detail.id).textContent = data[1][0];
                    }
                }).catch(error => console.error(`Error fetching ${detail.id} data:`, error));
            });
        }

        // Initial data load
        updateData();

        // Set interval to update data every 1 minute (60000 milliseconds)
        setInterval(updateData, 60000);
    </script>
</body>
</html>

